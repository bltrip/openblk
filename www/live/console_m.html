<!DOCTYPE html>
<html>
<head>
<style>
body {
    margin:0px;
    height:100%;
}
#main-canvas {position:absolute;
             width:100%;
             height:100%;
             z-index:-1;
             }


   body {color:white; font-family:Helvetica; }

   .mike {color:white; z-index:1; padding:5%; font-size:6em; text-align:center;}

   .calvin, .pedro {
      color:white;
      display:inline-block;
      text-align:center;
      width:40%;
      font-size:5em;
      padding-top:40px;
   }

   .calvin {padding-left:10%;}

</style>

<script src="/socket.io/socket.io.js"></script>
<script>
    var socket = io("/console");  
</script>
</head>

<body>

<canvas id="main-canvas">
</canvas>

   <div class="mike">Mike Helland</div>
   <div class="calvin">Calvin Todd Stephens</div>
   <div class="pedro">Pedro <br/>Bartes</div>

<script>

var audioMode = 0;

var canvas = document.getElementById("main-canvas");
var ctx = canvas.getContext("2d");

var isTouching = false;

var colors = [ "#FFFFFF", "#FF0000", "#FFFF00", "#00FF00", "#0000FF",
            "#FF8000", "#9E9E9E", "#00FFFF", "#800080", "#632DFF", "#63FF08" ];

var width = window.innerWidth;
var height = window.innerHeight;
canvas.clientWidth = width + "px";
canvas.clientHeight = height + "px";
canvas.width = canvas.clientWidth;
canvas.height = canvas.clientHeight;

var app = {};
app.clear = function () {
    users.forEach(function (user) {
        user.history = [];
    });  
    canvas.width = canvas.width; 
};

app.clearAlpha = 1;
app.framesBetweenFadeFrame = 0;
app.framesSinceLastFadeFrame = 0;

app.maxHistoryLength = 50;

app.messages = ["MikeHelland.com", "MOB ROLL 2016", "Big Building, Seattle"];
app.currentMessageI = 0;
app.messageStartTime = Date.now();

var users = [];
var findUser = function (data) {
    for (var iu = 0; iu < users.length; iu++) {
        if (users[iu].username == data.user) {
            return users[iu];
        }
    }   
    
    var user = {"username": data.user, "firsttime": Date.now(), "lastX": -1};
    user.color = colors[data.colorI];
    user.history = [];
    user.startTime = Date.now();
    users.push(user);
    return user;
};

var drawMessage = function () {
    var msg = app.messages[app.currentMessageI];

    var perct = (Date.now() - app.messageStartTime) / 30000;
    if (perct >= 1) {
        perct = 0;
        app.messageStartTime = Date.now();
        app.currentMessageI = (app.currentMessageI + 1) % app.messages.length;
    }

    ctx.font = perct * 40 + 32 + "pt Helvetica";
    var width = ctx.measureText(msg).width;

    ctx.globalAlpha = perct;
    ctx.fillStyle = "white";
    ctx.fillText(msg, window.innerWidth / 2 - width / 2, window.innerHeight / 1.8);
    ctx.globalAlpha = 1;
};

var drawCanvas = function () {
    //canvas.width = canvas.width;
    //ctx.lineWidth = 2;
    
    if (app.framesSinceLastFadeFrame == app.framesBetweenFadeFrame) {
        ctx.fillStyle = "black";
        ctx.globalAlpha = app.clearAlpha;
        ctx.fillRect(0, 0, width, height);
        ctx.globalAlpha = 1;
        app.framesSinceLastFadeFrame = 0;
    } else {
        app.framesSinceLastFadeFrame++;
    }

    //drawMessage();    
    users.forEach(function (user) {
        user.history = user.history.filter(function (data, i) {

            if (i < user.history.length - app.maxHistoryLength) {
                return false;
            }

            drawCircle(data[0], data[1], user.color);
            return true;
        });
        //if (user.lastX > -1) {
        //    drawCircle(user.lastX, user.lastY, user.color);
        //}
    });
    setTimeout(drawCanvas, 33);
};

var drawCircle = function (x, y, color) {

        
    ctx.beginPath();
    ctx.arc(x * width, y * height, 10, 0, 2 * Math.PI);
    //ctx.stroke();
    ctx.fillStyle = color;
    ctx.fill();
    
};

socket.on("playnote", function (data) {

    var user = findUser(data);
    user.lastX = data.x;
    user.lastY = data.y;
    user.history.push([data.x, data.y, Date.now() - user.startTime]);

    if (!user.audio) {
        user.audio = setupAudioChannel(data.colorI);
        console.log("setting up osc for user " + data.user);
    }

    if (audioMode > 0) {
        return;
    }
        
    if (data.x == -1) {
       user.audio.osc.frequency.value = 0;
        user.audio.volume.gain.value = 0;
    }
    else {
        user.audio.volume.gain.value = 0.5;
        user.audio.osc.frequency.setValueAtTime(buildFrequency(ascale, 3, 1 - data.y, 48), 0);
        user.audio.panner.setPosition(0, 0, (data.x - 0.5) * 10)
    }
});

var currentUserI = -1;
var lastUserPlayed;
var rootNote = 48;
var playNotes = function () {
    if (lastUserPlayed) {
        lastUserPlayed.audio.volume.gain.value = 0;
        lastUserPlayed = false;
    }
    
    if (audioMode < 1) {
        return;
    }
    
    currentUserI++;
    
    if (currentUserI >= users.length) {
        currentUserI = -1;
        return;
    }
    console.log(currentUserI);
    while (users[currentUserI].lastX == -1) {
        currentUserI++;
        if (currentUserI >= users.length) {
            currentUserI = -1;
            return;
        }
    }
    
    var user = users[currentUserI];
    if (user.lastX == -1) {
        user.audio.volume.gain.value = 0;
        user.audio.osc.frequency.value = 0;
    }
    else {
        user.audio.volume.gain.value = 0.5;
        user.audio.osc.frequency.setValueAtTime(buildFrequency(ascale, 3, 1 - user.lastY, rootNote), 0);
        user.audio.panner.setPosition(0, 0, (user.lastX - 0.5) * 10)
    }
    lastUserPlayed = user;

};

drawCanvas();
setInterval(playNotes, 62.5);

var audioCtx = new AudioContext();

var setupAudioChannel = function (color) {

    var channel = {};

    channel.osc = audioCtx.createOscillator();
    channel.volume = audioCtx.createGain();
    channel.osc.connect(channel.volume);
    channel.panner = audioCtx.createPanner();
    channel.volume.connect(channel.panner);
    channel.panner.connect(audioCtx.destination);
    channel.panner.setPosition(0, 0, 0);

    var instrumentType = 0;
    var ldelay = false;
    var softEnvelope = false; // TODO slow attack and sustain if true
    if (color == 0) {
        ldelay = true;
        softEnvelope = true;
    } else if (color == 1) {
    } else if (color == 2) {
        softEnvelope = true;
        instrumentType = 1;
    } else if (color == 3) {
        instrumentType = 1;
    } else if (color == 4) {
        softEnvelope = true;
        instrumentType = 1;
    } else if (color == 5) {
        instrumentType = 1;
    } else if (color == 6) {
        softEnvelope = true;
        instrumentType = 1;
        ldelay = true;
    } else if (color == 7) {
        softEnvelope = true;
        instrumentType = 2;
    } else if (color == 8) {
        instrumentType = 2;
    } else if (color == 9) {
        instrumentType = 2;
        ldelay = true;
        softEnvelope = true;
    } else if (color == 10) {
        instrumentType = 2;
        ldelay = true;
    }
    channel.osc.type = instrumentType == 0 ? "sine" : 
            instrumentType == 1 ? "square" :
            "sawtooth"
            
    if (ldelay) {
        channel.delay = audioCtx.createDelay();
        channel.delayGain = audioCtx.createGain();
        channel.delayGain.gain.value = 0.25;
        
        channel.delay.delayTime.value = 0.25;
        
        channel.panner.connect(channel.delay);
        channel.delay.connect(channel.delayGain);
        channel.delayGain.connect(channel.delay);
        channel.delayGain.connect(audioCtx.destination); //master gain?
    }


    channel.osc.frequency.value = 0;
    channel.osc.start();

    return channel;
};


// these two functions are translated from Adam Smith's Android code
var buildScale = function(quantizerString) {
    if (quantizerString != null && quantizerString.length > 0) {
        var parts = quantizerString.split(",");
        var scale = []; // new float[parts.length];
        for ( var i = 0; i < parts.length; i++) {
            scale[i] = parseFloat(parts[i]);
        }
        return scale;
    } else {
        return null;
    }
};
var buildFrequency = function(scale, octaves, input, base) {
    input = Math.min(Math.max(input, 0.0), 1.0);
    var mapped = 0;
    if (scale == null) {
        mapped = base + input * octaves * 12.0;
    } else {
        var idx = Math.floor((scale.length * octaves + 1) * input);
        mapped = base + scale[idx % scale.length] + 12
                * Math.floor(idx / scale.length);
    }
    return Math.pow(2, (mapped - 69.0) / 12.0) * 440.0;
};


var ascale = buildScale("0,2,4,5,7,9,11")

document.body.onkeyup = function(e){
    if(e.keyCode == 32){
        audioMode++;
        if (audioMode == 2) {
            audioMode = 0;
        }
        console.log(audioMode);
    } else if (e.keyCode == 46) {
        app.clear();
    } else if (e.keyCode == 69) {
        rootNote = 55;
    }
    console.log(e.keyCode);
};




</script>

</body>
</html>
